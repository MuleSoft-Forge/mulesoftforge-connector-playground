<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:oauth="http://www.mulesoft.org/schema/mule/oauth"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:ms-agentforce="http://www.mulesoft.org/schema/mule/ms-agentforce" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd 
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ms-agentforce http://www.mulesoft.org/schema/mule/ms-agentforce/current/mule-ms-agentforce.xsd
http://www.mulesoft.org/schema/mule/oauth http://www.mulesoft.org/schema/mule/oauth/current/mule-oauth.xsd">


    <http:request-config name="Salesforce_HTTP_Config" doc:name="HTTP Request configuration">
        <http:request-connection host="#[(vars.runtimeConfigForConnector.salesforceOrg default p('salesforce.einstein.salesforceOrg'))]" port="443" protocol="HTTPS">
            <http:authentication>
                <oauth:client-credentials-grant-type
                    clientId="#[(vars.runtimeConfigForConnector.clientId default p('salesforce.einstein.clientId'))]"
                    clientSecret="#[(vars.runtimeConfigForConnector.clientSecret default p('salesforce.einstein.clientSecret'))]"
                    tokenUrl="#[(vars.runtimeConfigForConnector.tokenUrl default p('salesforce.einstein.tokenUrl'))]" scopes="#[(vars.runtimeConfigForConnector.scopes default p('salesforce.einstein.scopes'))]">
                </oauth:client-credentials-grant-type>
            </http:authentication>
        </http:request-connection>
    </http:request-config>
    
	<ms-agentforce:config name="Agentforce_Configuration"
	    doc:name="Agentforce Configuration"
	    doc:id="aea77ff4-dc7d-4cd5-8a56-a00273e644e2">
	    
        <ms-agentforce:oauth-client-credentials-connection>
            <ms-agentforce:oauth-client-credentials 
            clientId="#[(vars.runtimeConfigForConnector.clientId default p('salesforce.einstein.clientId'))]" 
            clientSecret="#[(vars.runtimeConfigForConnector.clientSecret default p('salesforce.einstein.clientSecret'))]" 
            tokenUrl="#[(vars.runtimeConfigForConnector.tokenUrl default p('salesforce.einstein.tokenUrl'))]" 
            scopes="#[(vars.runtimeConfigForConnector.scopes default p('salesforce.einstein.scopes'))]"
            />
        </ms-agentforce:oauth-client-credentials-connection>
        
    </ms-agentforce:config>
	<sub-flow name="execute-agentforce" doc:id="c4ee132d-d8c3-46d9-9761-3740210749a1" >
		<choice doc:name="Choice" doc:id="ef995d37-08d7-42b0-8287-f49eaf32a063">
					<when expression='#["ms-agentforce:start-agent-conversation" == vars.operation.operation_key]'>
						<choice doc:name="Choice" doc:id="e742e356-3bba-4f63-9f58-d70209a96def">
							<when expression='#[payload.parameters.agentList == "0XxKa0000007qzVKAQ"]'>
								<ms-agentforce:start-agent-conversation agent="0XxKa0000007qzVKAQ" doc:name="Start agent conversation" doc:id="9c739ee8-990f-4783-a155-03569fc9d60d" config-ref="Agentforce_Configuration" byPassUser="#[payload.parameters.bypassUser default false as Boolean]" />
							</when>
							<otherwise>
								<raise-error doc:name="Raise error" doc:id="df4fc347-e84d-44af-ae1f-49d4985bbba1" type="CUSTOM:CUSTOM_ERROR" description="AgentList Item Not Supported" />
							</otherwise>
						</choice>
					</when>
					<when expression='#["ms-agentforce:continue-agent-conversation" == vars.operation.operation_key]'>
						<ms-agentforce:continue-agent-conversation doc:name="Continue agent conversation" doc:id="a6939b50-312c-4f30-89e2-c534529cba50" config-ref="Agentforce_Configuration" messageSequenceNumber="#[payload.parameters.messageSequenceNumber]">
							<ms-agentforce:message><![CDATA[#[payload.parameters.message]]]></ms-agentforce:message>
							<ms-agentforce:session-id><![CDATA[#[payload.parameters.sessionId]]]></ms-agentforce:session-id>
						</ms-agentforce:continue-agent-conversation>
					</when>
					<when expression='#["ms-agentforce:end-agent-conversation" == vars.operation.operation_key]'>
						<ms-agentforce:end-agent-conversation doc:name="End agent conversation" doc:id="e2e1eb3f-ab04-40d2-9de8-0f910eb47b84" config-ref="Agentforce_Configuration">
							<ms-agentforce:session-id><![CDATA[#[payload.parameters.sessionId]]]></ms-agentforce:session-id>
						</ms-agentforce:end-agent-conversation>
					</when>
					<otherwise>
						<raise-error doc:name="Raise error" doc:id="e4ab29d6-ee57-49e7-81c6-be3889fbb69c" type="CUSTOM:CUSTOM_ERROR" description="operationId Not Supported" />
					</otherwise>
				</choice>
		<ee:transform doc:name="Transform to ExecutionResponse" doc:id="314ca9f0-18a8-4c5c-bbcf-e9dcd74dd6fb">
							<ee:message>
								<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  executionId: vars.executionId default uuid(),
  status: "success",
  result: {
    payload: payload default {},
    attributes: attributes default {}
  },
  timestamp: now() as String {format: "yyyy-MM-dd'T'HH:mm:ss'Z'"}
}]]></ee:set-payload>
							</ee:message>
						</ee:transform>
	</sub-flow>
</mule>
